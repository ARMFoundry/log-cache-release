#!/bin/bash -e

RUN_DIR=/var/vcap/sys/run/expvar-scraper
LOG_FILE=/var/vcap/sys/log/expvar-scraper/expvar-scraper.log
LOG_DIR=$(dirname $LOG_FILE)
PIDFILE=${RUN_DIR}/expvar-scraper.pid
JOB_DIR=/var/vcap/jobs/expvar-scraper

mkdir -p $RUN_DIR $LOG_DIR
chown -R vcap:vcap $RUN_DIR $LOG_DIR

case $1 in

  start)
    if [ -f $PIDFILE ]; then
      set +e
        killall -15 scrape
        killall -9 scrape
        killall -2 scrape
        killall -3 scrape
      set -e
    fi

    ulimit -n 8192

    echo $$ > $PIDFILE
    exec chpst -u vcap:vcap $JOB_DIR/bin/scrape "<%= p('health_addr') %>" \
      "<%= p('datadog.host')%>" \
      "<%= p('datadog.api_key')%>" \
      "<%= p('metrics.namespace')%>" &>> ${LOG_FILE}

    ;;

  stop)
    if [ -f $PIDFILE ]; then
      set +e
        killall -15 scrape
        killall -9 scrape
        killall -2 scrape
        killall -3 scrape
      set -e
    fi

    rm -f $PIDFILE

    ;;

  *)
    echo "Usage: ctl {start|stop}"

    ;;

esac

